---
// index.astro
// Página principal simplificada de CANARY ISLANDS GAMES

import BaseLayout from '@/layouts/BaseLayout.astro';
import { getHomeContent } from '@/lib/cms/queries';
import { urlFor } from '@/lib/cms/sanityClient';

let homeContent;
try {
  homeContent = await getHomeContent();
} catch (error) {
  // Valores por defecto si no hay contenido en Sanity
  homeContent = {
    backgroundImage: null,
    topImage: null,
    centerImage: null,
    eventIntro: null,
    schedule: [],
    mesaRedonda1Image: null,
    mesaRedonda2Image: null,
    attendeeFormUrl: '#',
    developerFormUrl: '#',
  };
}

// Generar URLs de imagen optimizadas para diferentes tamaños
const backgroundImageUrlMobile = homeContent.backgroundImage 
  ? urlFor(homeContent.backgroundImage).width(768).height(1024).url()
  : null;
const backgroundImageUrlTablet = homeContent.backgroundImage 
  ? urlFor(homeContent.backgroundImage).width(1024).height(768).url()
  : null;
const backgroundImageUrlDesktop = homeContent.backgroundImage 
  ? urlFor(homeContent.backgroundImage).width(1920).height(1080).url()
  : null;
const backgroundImageUrl = backgroundImageUrlDesktop;

// Generar URLs de imagen superior optimizadas para diferentes tamaños (responsive)
// Usando fit('max') para respetar la relación de aspecto original
const topImageUrlMobile = homeContent.topImage 
  ? urlFor(homeContent.topImage).width(1010).fit('max').url()
  : null;
const topImageUrlTablet = homeContent.topImage 
  ? urlFor(homeContent.topImage).width(600).fit('max').url()
  : null;
const topImageUrlDesktop = homeContent.topImage 
  ? urlFor(homeContent.topImage).width(1010).fit('max').url()
  : null;
const topImageUrl = topImageUrlDesktop;

// Generar URLs de imagen centrada optimizadas para diferentes tamaños (responsive)
// Usando fit('max') para respetar la relación de aspecto original (1010x749px)
const centerImageUrlMobile = homeContent.centerImage 
  ? urlFor(homeContent.centerImage).width(1010).fit('max').url()
  : null;
const centerImageUrlTablet = homeContent.centerImage 
  ? urlFor(homeContent.centerImage).width(600).fit('max').url()
  : null;
const centerImageUrlDesktop = homeContent.centerImage 
  ? urlFor(homeContent.centerImage).width(1010).fit('max').url()
  : null;
const centerImageUrl = centerImageUrlDesktop;

// Generar URLs de imagen de mesa redonda 1 optimizadas para diferentes tamaños (responsive)
const mesaRedonda1UrlMobile = homeContent.mesaRedonda1Image 
  ? urlFor(homeContent.mesaRedonda1Image).width(400).fit('max').url()
  : null;
const mesaRedonda1UrlTablet = homeContent.mesaRedonda1Image 
  ? urlFor(homeContent.mesaRedonda1Image).width(600).fit('max').url()
  : null;
const mesaRedonda1UrlDesktop = homeContent.mesaRedonda1Image 
  ? urlFor(homeContent.mesaRedonda1Image).width(850).fit('max').url()
  : null;
const mesaRedonda1Url = mesaRedonda1UrlDesktop;

// Generar URLs de imagen de mesa redonda 2 optimizadas para diferentes tamaños (responsive)
const mesaRedonda2UrlMobile = homeContent.mesaRedonda2Image 
  ? urlFor(homeContent.mesaRedonda2Image).width(400).fit('max').url()
  : null;
const mesaRedonda2UrlTablet = homeContent.mesaRedonda2Image 
  ? urlFor(homeContent.mesaRedonda2Image).width(600).fit('max').url()
  : null;
const mesaRedonda2UrlDesktop = homeContent.mesaRedonda2Image 
  ? urlFor(homeContent.mesaRedonda2Image).width(850).fit('max').url()
  : null;
const mesaRedonda2Url = mesaRedonda2UrlDesktop;
---

<BaseLayout 
  title="CANARY ISLANDS GAMES - New International Hub for Videogames"
  description="CANARY ISLANDS GAMES is the department of the Canary Islands Government in charge of promoting our videogames industry."
>
  <div 
    class="min-h-screen flex flex-col items-center justify-between relative responsive-background"
    style={backgroundImageUrl ? `
      --bg-mobile: url('${backgroundImageUrlMobile || backgroundImageUrl}');
      --bg-tablet: url('${backgroundImageUrlTablet || backgroundImageUrl}');
      --bg-desktop: url('${backgroundImageUrl}');
    ` : 'background: linear-gradient(to bottom, #1e40af, #3b82f6);'}
  >
    <!-- Overlay oscuro opcional para mejorar legibilidad -->
    <div class="absolute inset-0 bg-black bg-opacity-20"></div>
    
    <!-- Contenedor principal con imagen centrada y botones abajo -->
    <div class="relative z-10 w-full min-h-screen flex flex-col items-center justify-between overflow-visible">
      <!-- Imágenes centradas vertical y horizontalmente -->
      <div class="flex-1 flex flex-col items-center justify-center py-6 sm:py-10 md:py-12 px-4 w-full overflow-visible gap-8 sm:gap-6 md:gap-8">
        <!-- Imagen superior -->
        {topImageUrl && (
          <div class="flex items-center justify-center w-full overflow-visible">
            <picture class="flex justify-center w-full">
              <source media="(min-width: 1024px)" srcset={topImageUrlDesktop || topImageUrl} />
              <source media="(min-width: 640px)" srcset={topImageUrlTablet || topImageUrl} />
              <img
                src={topImageUrlMobile || topImageUrl}
                alt="Canary Islands Games"
                class="drop-shadow-2xl w-auto h-auto max-w-[85vw] sm:max-w-[50vw] max-h-[20vh] sm:max-h-[15vh] object-contain mx-auto"
              />
            </picture>
          </div>
        )}
        
        <!-- Imagen principal centrada -->
        {centerImageUrl && (
          <div class="flex items-center justify-center w-full overflow-visible">
            <picture class="flex justify-center w-full">
              <source media="(min-width: 1024px)" srcset={centerImageUrlDesktop || centerImageUrl} />
              <source media="(min-width: 640px)" srcset={centerImageUrlTablet || centerImageUrl} />
              <img
                src={centerImageUrlMobile || centerImageUrl}
                alt="Canary Islands Games"
                class="drop-shadow-2xl w-auto h-auto max-w-[95vw] sm:max-w-[70vw] max-h-[70vh] sm:max-h-[55vh] object-contain mx-auto"
              />
            </picture>
          </div>
        )}
    </div>
    
      <!-- Botón y descripción del evento -->
      <div class="w-full pb-1 sm:pb-8 md:pb-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto flex flex-col items-center gap-4 sm:gap-6">
          <!-- Botón de inscripción -->
          <a 
            href={homeContent.attendeeFormUrl || '#'}
            class="glass-neon-button text-center"
            aria-label="Inscripción"
          >
            Inscripción
          </a>
          
          <!-- Indicador de scroll (solo desktop) -->
          <div id="scroll-indicator" class="hidden lg:flex flex-col items-center justify-center mt-4 transition-opacity duration-300">
            <svg 
              class="w-6 h-6 text-white animate-bounce drop-shadow-lg" 
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
            </svg>
          </div>
          
          <!-- Intro del evento -->
          {homeContent.eventIntro && (
            <div class="text-center text-white max-w-2xl mx-auto px-4 mt-8 sm:mt-12 md:mt-16">
              <p class="text-sm sm:text-base md:text-lg leading-relaxed drop-shadow-lg whitespace-pre-line">
                {homeContent.eventIntro}
        </p>
      </div>
          )}
          
          <!-- Timeline de horario -->
          {homeContent.schedule && homeContent.schedule.length > 0 && (
            <div class="w-full max-w-7xl xl:max-w-[90rem] mx-auto mt-6 sm:mt-8 px-4">
              <h2 class="text-white text-xl sm:text-2xl font-bold text-center mb-6 sm:mb-8 drop-shadow-lg">
                Horario
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6 xl:gap-8">
                {homeContent.schedule.map((item) => {
                  const mesaLink = item.mesaRedondaLink ? `#mesa-redonda-${item.mesaRedondaLink}` : null;
                  
                  if (mesaLink) {
                    return (
                      <a 
                        href={mesaLink}
                        class="bg-white/10 backdrop-blur-sm border border-white/20 p-4 sm:p-6 rounded-lg block transition-all duration-300 hover:bg-white/15 hover:border-white/30 cursor-pointer"
                      >
                        {item.time && (
                          <div class="text-white/80 text-xs sm:text-sm font-semibold mb-2">
                            {item.time}
                          </div>
                        )}
                        {item.title && (
                          <h3 class="text-[#FFE900] text-base sm:text-lg font-semibold mb-2 drop-shadow-[0_0_4px_rgba(255,233,0,0.5)]">
                            {item.title}
                          </h3>
                        )}
                        {item.description && (
                          <p class="text-white/90 text-sm sm:text-base leading-relaxed whitespace-pre-line">
                            {item.description}
                          </p>
                        )}
                      </a>
                    );
                  }
                  
                  return (
                    <div class="bg-white/10 backdrop-blur-sm border border-white/20 p-4 sm:p-6 rounded-lg">
                      {item.time && (
                        <div class="text-white/80 text-xs sm:text-sm font-semibold mb-2">
                          {item.time}
                        </div>
                      )}
                      {item.title && (
                        <h3 class="text-[#FFE900] text-base sm:text-lg font-semibold mb-2 drop-shadow-[0_0_4px_rgba(255,233,0,0.5)]">
                          {item.title}
                        </h3>
                      )}
                      {item.description && (
                        <p class="text-white/90 text-sm sm:text-base leading-relaxed whitespace-pre-line">
                          {item.description}
                        </p>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          <!-- Imagen de Mesa Redonda 1 -->
          {mesaRedonda1Url && (
            <div id="mesa-redonda-1" class="w-full max-w-5xl mx-auto mt-8 sm:mt-12 px-4 scroll-mt-20">
              <div class="flex items-center justify-center w-full overflow-visible">
                <picture class="flex justify-center w-full">
                  <source media="(min-width: 1024px)" srcset={mesaRedonda1UrlDesktop || mesaRedonda1Url} />
                  <source media="(min-width: 640px)" srcset={mesaRedonda1UrlTablet || mesaRedonda1Url} />
                  <img
                    src={mesaRedonda1UrlMobile || mesaRedonda1Url}
                    alt="Mesa Redonda 1"
                    class="drop-shadow-2xl w-auto h-auto max-w-[95vw] sm:max-w-[80vw] lg:max-w-[70vw] object-contain mx-auto"
                  />
                </picture>
              </div>
            </div>
          )}
          
          <!-- Imagen de Mesa Redonda 2 -->
          {mesaRedonda2Url && (
            <div id="mesa-redonda-2" class="w-full max-w-5xl mx-auto mt-8 sm:mt-12 px-4 scroll-mt-20">
              <div class="flex items-center justify-center w-full overflow-visible">
                <picture class="flex justify-center w-full">
                  <source media="(min-width: 1024px)" srcset={mesaRedonda2UrlDesktop || mesaRedonda2Url} />
                  <source media="(min-width: 640px)" srcset={mesaRedonda2UrlTablet || mesaRedonda2Url} />
                  <img
                    src={mesaRedonda2UrlMobile || mesaRedonda2Url}
                    alt="Mesa Redonda 2"
                    class="drop-shadow-2xl w-auto h-auto max-w-[95vw] sm:max-w-[80vw] lg:max-w-[70vw] object-contain mx-auto"
                  />
                </picture>
              </div>
            </div>
          )}
        </div>
      </div>
      
    </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Ocultar flecha de scroll cuando el usuario hace scroll
  document.addEventListener('DOMContentLoaded', () => {
    const scrollIndicator = document.getElementById('scroll-indicator');
    if (!scrollIndicator) return;

    let lastScrollTop = 0;
    const scrollThreshold = 100; // Píxeles de scroll antes de ocultar

    const handleScroll = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      if (scrollTop > scrollThreshold) {
        scrollIndicator.style.opacity = '0';
        scrollIndicator.style.pointerEvents = 'none';
      } else {
        scrollIndicator.style.opacity = '1';
        scrollIndicator.style.pointerEvents = 'auto';
      }
      
      lastScrollTop = scrollTop;
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Verificar estado inicial
    handleScroll();
  });
</script>
